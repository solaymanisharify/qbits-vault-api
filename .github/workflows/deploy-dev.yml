name: Deploy Laravel API to cPanel

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, zip, gd, intl, bcmath, pdo_mysql
          ini-values: |
            memory_limit=512M
          coverage: none
          
      # Cache Composer Dependencies
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      # Validate Composer files
      - name: Validate composer.json and composer.lock
        run: composer validate --strict
        
      # Install Laravel Dependencies
      - name: Install Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction
        
      # Set Correct Environment File
      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "APP_ENV=production" > .env
            echo "APP_DEBUG=false" >> .env
            echo "DB_DATABASE=${{ secrets.LIVE_DB_DATABASE }}" >> .env
            echo "DB_USERNAME=${{ secrets.LIVE_DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.LIVE_DB_PASSWORD }}" >> .env
            echo "DB_HOST=${{ secrets.LIVE_DB_HOST || '127.0.0.1' }}" >> .env
          else
            echo "APP_ENV=development" > .env
            echo "APP_DEBUG=true" >> .env
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_HOST=${{ secrets.DB_HOST || '127.0.0.1' }}" >> .env
          fi
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
        shell: bash
        
      # Upload Laravel Files to cPanel via FTP
      - name: Deploy Laravel to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_FTP_SERVER || secrets.FTP_SERVER }}
          username: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_FTP_USERNAME || secrets.FTP_USERNAME }}
          password: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_FTP_PASSWORD || secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /
          protocol: ftp
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/tests/**
            
      # Run Laravel Migrations via SSH (FTP can't run commands)
      # Note: You cannot run artisan commands via FTP - you need SSH access
      # This step will fail unless you have SSH access to your cPanel
      # - name: Run Laravel Migrations
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_SSH_HOST || secrets.SSH_HOST }}
      #     username: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_SSH_USERNAME || secrets.SSH_USERNAME }}
      #     password: ${{ github.ref == 'refs/heads/main' && secrets.LIVE_SSH_PASSWORD || secrets.SSH_PASSWORD }}
      #     script: |
      #       cd /path/to/your/laravel
      #       php artisan migrate --force
